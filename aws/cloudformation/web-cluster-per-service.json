{
  "Parameters": {
    "ServiceName": {
      "Type": "String",
      "Description": "the name of the service, e.g. item, store, etc"
    },
    "ServiceSecret": {
      "Type": "String",
      "Description": "Secret for inter-service authentication"
    },

    "IndexUserId": {
      "Type": "String",
      "Description": "whether to add a 'userId' to the table keyschema",
      "AllowedValues": ["Yes", "No"]
    },
    "ReadCapacityUnits": {
      "Type": "String",
      "Description": "table capacity - read"
    },
    "WriteCapacityUnits": {
      "Type": "String",
      "Description": "table capacity - write"
    },

    "LambdaTimeout": {
      "Type": "String"
    },
    "LambdaHandler": {
      "Type": "String",
      "Description": "Handler for the lambda, e.g. 'server/lambda.handler', 'lib/bundle-min.handler'"
    },

    "WithTable": {
      "Type": "String",
      "Description": "Boolean describing whether a table should be referenced",
      "AllowedValues": ["Yes", "No"]
    },
    "CreateTable": {
      "Type": "String",
      "Description": "Boolean describing whether a table should be created and owned by this stack (as opposed to pre-existing)",
      "AllowedValues": ["Yes", "No"]
    },
    "CreateLambda": {
      "Type": "String",
      "Description": "Boolean describing whether a lambda should be created and owned by this stack (as opposed to pre-existing)",
      "AllowedValues": ["Yes", "No"]
    },
    "UserSecret": {
      "Type": "String",
      "Description": "The user secret (or empty) for this service"
    },
    "StripeKeyLive": {
      "Type": "String",
      "Description": "Stripe live secret"
    },
    "StripeKeyTest": {
      "Type": "String",
      "Description": "Stripe test secret"
    },
    "WithApiGateway": {
      "Type": "String",
      "Description": "Boolean describing whether the lambda is exposed on ApiGateway",
      "AllowedValues": ["Yes", "No"]
    },
    "HSPrefix": {
      "Type": "String",
      "Description": "Prefix for all shared names, e.g. \"honesty-store\", \"hs\""
    },
    "HSDomainName": {
      "Type": "String",
      "Description": "The domain name under which this deployment should be deployed"
    },
    "ServicePrefix": {
      "Type": "String",
      "Description": "Prefix for all service-based names, e.g. \"honesty-store\", \"hs-<branch>\""
    }
  },

  "Conditions": {
    "WithApiGateway": {
      "Fn::Equals": [ { "Ref": "WithApiGateway" }, "Yes" ]
    },
    "IndexUserId": {
      "Fn::Equals": [ {"Ref": "IndexUserId"}, "Yes" ]
    },
    "WithTable": {
      "Fn::Equals": [ {"Ref": "WithTable"}, "Yes" ]
    },
    "CreateTable": {
      "Fn::Equals": [ {"Ref": "CreateTable"}, "Yes" ]
    },
    "CreateLambda": {
      "Fn::Equals": [ {"Ref": "CreateLambda"}, "Yes" ]
    }
  },

  "Resources": {
    "Table": {
      "Condition": "CreateTable",
      "Type": "AWS::DynamoDB::Table",
      "DeletionPolicy": "Retain",
      "Properties": {
        "TableName": {
          "Fn::Join": [
            "",
            [
              { "Ref": "ServicePrefix" },
              "-",
              { "Ref": "ServiceName" }
            ]
          ]
        },
        "KeySchema": [ { "AttributeName": "id", "KeyType": "HASH" } ],
        "AttributeDefinitions": [
          { "AttributeName": "id", "AttributeType": "S" },
          {
            "Fn::If": [
              "IndexUserId",
              {
                "AttributeName": "userId",
                "AttributeType": "S"
              },
              { "Ref": "AWS::NoValue" }
            ]
          }
        ],
        "ProvisionedThroughput": {
          "ReadCapacityUnits": {
            "Ref": "ReadCapacityUnits"
          },
          "WriteCapacityUnits": {
            "Ref": "WriteCapacityUnits"
          }
        },
        "GlobalSecondaryIndexes": [{
          "Fn::If": [
            "IndexUserId",
            {
              "IndexName": "userId",
              "KeySchema": [{
                "AttributeName": "userId",
                "KeyType": "HASH"
              }],
              "Projection": {
                "ProjectionType": "KEYS_ONLY"
              },
              "ProvisionedThroughput": {
                "ReadCapacityUnits": 1,
                "WriteCapacityUnits": 1
              }
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        }],
        "TimeToLiveSpecification": {
          "AttributeName": "ttl",
          "Enabled": true
        }
      }
    },
    "LambdaApiGateway": {
      "Condition": "WithApiGateway",
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": {
          "Fn::Join": [
            "",
            [
              { "Ref": "ServicePrefix" },
              "-",
              { "Ref": "ServiceName" }
            ]
          ]
        },
        "Principal": "apigateway.amazonaws.com"
      }
    }
  }
}
